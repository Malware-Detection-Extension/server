// 📄 대상 확장자: .rtf
// 🧩 대상 프로그램: Microsoft Word, WordPad 등
// 🎯 탐지 목적: RTF 문서 내 OLE 개체, 쉘코드, 취약점 공격 패턴 탐지

rule RTF_Embedded_OLE_Object
{
    meta:
        description = "RTF 문서 내 OLE 개체 삽입 탐지 ({\\object, {\\objdata})"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $obj1 = "{\\object" ascii nocase
        $obj2 = "{\\objdata" ascii nocase
        $class = "objclass" ascii nocase
        $exe = ".exe" ascii nocase

    condition:
        $header at 0 and (2 of ($obj*, $class, $exe))
}

rule RTF_Nop_Sled_Heuristic
{
    meta:
        description = "RTF 문서 내 NOP sled 기반 쉘코드 존재 가능성 탐지"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $nop = { 90 90 90 90 90 90 90 90 90 90 }  // 긴 NOP sled
        $jmp = { E9 ?? ?? ?? ?? }                // jmp instruction
        $call = { E8 ?? ?? ?? ?? }               // call instruction

    condition:
        $header at 0 and (1 of ($nop, $jmp, $call))
}

rule RTF_Exploit_CVE_2017_11882
{
    meta:
        description = "CVE-2017-11882 EQNEDT32 취약점 시도 탐지"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $eqn = "EQNEDT32.EXE" ascii nocase
        $obj = "{\\object" ascii
        $oledata = "{\\*\\objdata" ascii

    condition:
        all of them
}

rule RTF_Suspicious_Shell_Strings
{
    meta:
        description = "RTF 내 외부 실행 가능성이 있는 의심 문자열 탐지"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $cmd = "cmd.exe" ascii nocase
        $ps = "powershell" ascii nocase
        $url = /http[s]?:\/\/[^\s]+/ ascii
        $dll = ".dll" ascii nocase
        $bat = ".bat" ascii nocase

    condition:
        2 of them
}

// 휴리스틱 기반 탐지 규칙들
rule RTF_Heuristic_Byte_Nibble_Obfuscation
{
    meta:
        description = "RTF 바이트 nibble 난독화 기법 탐지"
        author = "Kim"
        severity = "medium"
        category = "heuristic"
        filetype = "rtf"
        reference = "InQuest/yara-rules, Boris Larin research"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // Byte nibble 난독화 패턴들 - 바이트를 nibble로 분할
        $nibble_pattern1 = /\\[0-9a-fA-F]\\[0-9a-fA-F][0-9a-fA-F]/ ascii
        $nibble_pattern2 = /\\[0-9a-fA-F][0-9a-fA-F]\\[0-9a-fA-F]/ ascii
        $nibble_pattern3 = /\\[0-9a-fA-F]\\[0-9a-fA-F]\\[0-9a-fA-F]/ ascii
        
        // 16진수 인코딩과 분할 패턴
        $hex_split1 = /[0-9a-fA-F]{2}\\[0-9a-fA-F]{2}/ ascii
        $hex_split2 = /[0-9a-fA-F]\\[0-9a-fA-F]{3}/ ascii
        
        // 연속된 백슬래시 패턴
        $backslash_sequence = /\\\\[0-9a-fA-F]+\\\\[0-9a-fA-F]+/ ascii
        
        // 의심스러운 16진수 문자열 길이
        $long_hex_string = /[0-9a-fA-F]{100,}/ ascii

    condition:
        $rtf_header at 0 and 
        (2 of ($nibble_pattern*) or 3 of ($hex_split*) or 
         $backslash_sequence or ($long_hex_string and any of ($nibble_pattern*)))
}

rule RTF_Heuristic_OLE_Exploitation_Patterns
{
    meta:
        description = "RTF OLE 익스플로잇 패턴 조합 탐지"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "Neo23x0/signature-base, CVE analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // OLE 구조 패턴들
        $ole_object = "{\\object" ascii nocase
        $objdata = "{\\*\\objdata" ascii nocase
        
        // 익스플로잇 관련 객체 클래스들
        $equation_class = "Equation.3" ascii nocase
        $wordpad_class = "WordPad.Document.1" ascii nocase
        $package_class = "Package" ascii nocase
        $ole2link = "OLE2Link" ascii nocase
        
        // 셸코드 실행 패턴들
        $shellcode_marker = /0[1-9a-fA-F][0-9a-fA-F]{6,}/ ascii
        $exploit_padding = /90{20,}/ ascii  // NOP sled
        
        // CVE 관련 특정 패턴들
        $cve_2017_11882 = "EQNEDT32" ascii nocase
        $cve_2018_0802 = "4f1e5b9d-d05c-4564-ba2e-2b0420311520" ascii nocase

    condition:
        $rtf_header at 0 and $ole_object and $objdata and
        (any of ($equation_class, $wordpad_class, $package_class, $ole2link) and
         (any of ($shellcode_marker, $exploit_padding) or 
          any of ($cve_2017_11882, $cve_2018_0802)))
}

rule RTF_Heuristic_Template_Injection
{
    meta:
        description = "RTF 템플릿 인젝션 공격 패턴 탐지"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "sivolko/comprehensive-yara-rules"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // 템플릿 관련 RTF 제어어들
        $template = "\\template" ascii nocase
        $doctemp = "\\doctemp" ascii nocase
        $stylesheet = "\\stylesheet" ascii nocase
        
        // 외부 링크 패턴들
        $http_link = /\\field.*http[s]?:\/\/[^}]+/ ascii nocase
        $file_link = /\\field.*file:\/\/[^}]+/ ascii nocase
        $unc_path = /\\field.*\\\\[^}\\]+\\[^}]+/ ascii nocase
        
        // 하이퍼링크 필드들
        $hyperlink = "\\fldinst.*HYPERLINK" ascii nocase
        $includetext = "\\fldinst.*INCLUDETEXT" ascii nocase
        $includepicture = "\\fldinst.*INCLUDEPICTURE" ascii nocase
        
        // 의심스러운 확장자들
        $dotm_ext = ".dotm" ascii nocase
        $docm_ext = ".docm" ascii nocase
        $dot_ext = ".dot" ascii nocase

    condition:
        $rtf_header at 0 and
        (any of ($template, $doctemp, $stylesheet) or
         any of ($hyperlink, $includetext, $includepicture)) and
        (any of ($http_link, $file_link, $unc_path) and
         any of ($dotm_ext, $docm_ext, $dot_ext))
}

rule RTF_Heuristic_Macro_Execution_Vectors
{
    meta:
        description = "RTF 매크로 실행 벡터 탐지"
        author = "Kim"
        severity = "medium"
        category = "heuristic"
        filetype = "rtf"
        reference = "Yara-Rules/rules, embee-research analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // 매크로 관련 RTF 구조들
        $vba_project = "VBAProject" ascii nocase
        $macro_sheet = "Macrosheet" ascii nocase
        $auto_exec = "Auto_" ascii nocase
        
        // RTF 필드 코드들
        $field_code = "\\fldinst" ascii nocase
        $dde_field = "\\fldinst.*DDE" ascii nocase
        $macro_button = "\\fldinst.*MACROBUTTON" ascii nocase
        
        // 스크립트 실행 관련
        $wscript = "WScript" ascii nocase
        $vbscript = "VBScript" ascii nocase
        $javascript = "JavaScript" ascii nocase
        $powershell = "PowerShell" ascii nocase
        
        // 자동 실행 트리거들
        $on_open = "OnOpen" ascii nocase
        $auto_open = "AutoOpen" ascii nocase
        $document_open = "Document_Open" ascii nocase

    condition:
        $rtf_header at 0 and
        ($field_code and ($dde_field or $macro_button)) and
        (any of ($vba_project, $macro_sheet, $auto_exec) or
         any of ($wscript, $vbscript, $javascript, $powershell) or
         any of ($on_open, $auto_open, $document_open))
}

rule RTF_Heuristic_Suspicious_Encoding_Patterns
{
    meta:
        description = "RTF 의심스러운 인코딩 패턴 탐지"
        author = "Kim"
        severity = "low"
        category = "heuristic"
        filetype = "rtf"
        reference = "Didier Stevens research, InQuest Labs"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // 비정상적인 16진수 인코딩
        $hex_overload = /[0-9a-fA-F]{500,}/ ascii
        $mixed_case_hex = /[a-f]{10,}[A-F]{10,}/ ascii
        
        // 인코딩 제어문들
        $ansi_cpg = "\\ansicpg" ascii
        $uc_value = "\\uc" ascii
        $u_value = "\\u-" ascii  // 음수 유니코드
        
        // 특수 문자 인코딩
        $null_chars = "\\u0" ascii
        $control_chars = /\\u[0-2][0-9]/ ascii
        $high_ascii = /\\u[2-9][0-9]{3}/ ascii
        
        // 중복되거나 비정상적인 제어 시퀀스들
        $repeated_controls = /\\[a-z]+[0-9]*\\[a-z]+[0-9]*\\[a-z]+[0-9]*/ ascii
        $malformed_controls = /\\[^a-zA-Z]{2,}/ ascii
        
        // Base64와 유사한 패턴들
        $b64_like = /[A-Za-z0-9+\/]{50,}={0,2}/ ascii

    condition:
        $rtf_header at 0 and
        (($hex_overload or $mixed_case_hex) and
         (any of ($ansi_cpg, $uc_value, $u_value) or
          2 of ($null_chars, $control_chars, $high_ascii)) or
         ($repeated_controls and $malformed_controls) or
         ($b64_like and any of ($null_chars, $control_chars)))
}

rule RTF_Heuristic_Embedded_PE_Patterns
{
    meta:
        description = "RTF 내 임베디드 PE 파일 패턴 탐지"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "InQuest/yara-rules embedded PE analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // PE 헤더들 (16진수 인코딩된)
        $pe_mz = "4d5a" ascii nocase  // MZ
        $pe_header = "50450000" ascii nocase  // PE\0\0
        $dos_stub = "546869732070726f6772616d" ascii nocase  // "This program"
        
        // PE 섹션들
        $text_section = "2e74657874" ascii nocase  // .text
        $data_section = "2e64617461" ascii nocase  // .data
        $rdata_section = "2e7264617461" ascii nocase  // .rdata
        
        // DLL/EXE 관련 문자열들 (16진수 인코딩)
        $kernel32 = "4b45524e454c3332" ascii nocase  // KERNEL32
        $user32 = "5553455233320000" ascii nocase    // USER32
        $ntdll = "6e74646c6c2e646c6c" ascii nocase   // ntdll.dll
        
        // 실행 가능한 파일 확장자들
        $exe_extension = "2e657865" ascii nocase  // .exe
        $dll_extension = "2e646c6c" ascii nocase  // .dll
        $scr_extension = "2e736372" ascii nocase  // .scr
        
        // OLE 패키지 내 PE 구조
        $ole_package = "{\\object" ascii nocase
        $package_data = "\\objdata" ascii nocase

    condition:
        $rtf_header at 0 and
        ($pe_mz and ($pe_header or $dos_stub)) and
        (any of ($text_section, $data_section, $rdata_section) or
         any of ($kernel32, $user32, $ntdll)) and
        (any of ($exe_extension, $dll_extension, $scr_extension) or
         ($ole_package and $package_data))
}

rule RTF_Heuristic_Exploitation_Techniques_Combination
{
    meta:
        description = "RTF 익스플로잇 기법 조합 탐지"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "Multiple CVE analysis and threat research"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // 힙 스프레이 패턴들
        $heap_spray1 = /90{50,}/ ascii  // 긴 NOP sled
        $heap_spray2 = /41{50,}/ ascii  // AAAA pattern
        $heap_spray3 = /0c0c0c0c/ ascii nocase  // 반복 패턴
        
        // ROP 체인 패턴들
        $rop_gadget = /5[0-9a-fA-F]{7}/ ascii  // potential addresses
        $stack_pivot = /8b[0-9a-fA-F]{6}/ ascii  // mov instruction patterns
        
        // 메모리 손상 패턴들
        $buffer_overflow = /90{100,}/ ascii
        $format_string = /%[0-9]*[sdxp]/ ascii
        $integer_overflow = /ffff/ ascii nocase
        
        // 코드 실행 벡터들
        $code_exec1 = "\\fldinst.*DDE.*cmd" ascii nocase
        $code_exec2 = "{\\object.*\\objdata.*4d5a" ascii nocase  // OLE with PE
        $code_exec3 = "EQNEDT32" ascii nocase
        
        // 우회 기법들
        $obfuscation = /\\[0-9a-fA-F]\\[0-9a-fA-F]/ ascii  // nibble obfuscation
        $padding = /00{20,}/ ascii  // null padding
        
        // CVE 식별자들
        $cve_patterns = /(CVE-201[7-9]-[0-9]{4,5}|CVE-202[0-9]-[0-9]{4,5})/ ascii nocase

    condition:
        $rtf_header at 0 and
        (any of ($heap_spray*) or any of ($rop_gadget, $stack_pivot)) and
        (any of ($buffer_overflow, $format_string, $integer_overflow) or
         any of ($code_exec*)) and
        ($obfuscation or $padding or $cve_patterns)
}

rule RTF_Heuristic_High_Risk_Combination
{
    meta:
        description = "RTF 고위험 패턴 조합 탐지"
        author = "Kim"
        severity = "critical"
        category = "heuristic"
        filetype = "rtf"
        reference = "Comprehensive threat analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // OLE 객체 존재
        $ole_object = "{\\object" ascii nocase
        $objdata = "\\objdata" ascii nocase
        
        // 익스플로잇 클래스
        $exploit_class = /(Equation\.3|EQNEDT32|Package)/ ascii nocase
        
        // 셸코드 패턴
        $shellcode = /(90{20,}|4d5a[0-9a-fA-F]{10,})/ ascii nocase
        
        // 난독화
        $obfuscation = /\\[0-9a-fA-F]\\[0-9a-fA-F][0-9a-fA-F]/ ascii
        
        // 실행 벡터
        $execution = /(cmd\.exe|powershell|wscript|mshta)/ ascii nocase
        
        // 네트워크 활동
        $network = /http[s]?:\/\/[a-zA-Z0-9.-]+/ ascii nocase
        
        // 지속성 메커니즘
        $persistence = /(startup|\\Run\\|schtasks|autostart)/ ascii nocase

    condition:
        $rtf_header at 0 and $ole_object and $objdata and $exploit_class and
        ($shellcode and $obfuscation) and
        ($execution or $network or $persistence)
}

// ğŸ“„ ëŒ€ìƒ í™•ì¥ì: .rtf
// ğŸ§© ëŒ€ìƒ í”„ë¡œê·¸ë¨: Microsoft Word, WordPad ë“±
// ğŸ¯ íƒì§€ ëª©ì : RTF ë¬¸ì„œ ë‚´ OLE ê°œì²´, ì‰˜ì½”ë“œ, ì·¨ì•½ì  ê³µê²© íŒ¨í„´ íƒì§€

rule RTF_Embedded_OLE_Object
{
    meta:
        description = "RTF ë¬¸ì„œ ë‚´ OLE ê°œì²´ ì‚½ì… íƒì§€ ({\\object, {\\objdata})"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $obj1 = "{\\object" ascii nocase
        $obj2 = "{\\objdata" ascii nocase
        $class = "objclass" ascii nocase
        $exe = ".exe" ascii nocase

    condition:
        $header at 0 and (2 of ($obj*, $class, $exe))
}

rule RTF_Nop_Sled_Heuristic
{
    meta:
        description = "RTF ë¬¸ì„œ ë‚´ NOP sled ê¸°ë°˜ ì‰˜ì½”ë“œ ì¡´ì¬ ê°€ëŠ¥ì„± íƒì§€"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $nop = { 90 90 90 90 90 90 90 90 90 90 }  // ê¸´ NOP sled
        $jmp = { E9 ?? ?? ?? ?? }                // jmp instruction
        $call = { E8 ?? ?? ?? ?? }               // call instruction

    condition:
        $header at 0 and (1 of ($nop, $jmp, $call))
}

rule RTF_Exploit_CVE_2017_11882
{
    meta:
        description = "CVE-2017-11882 EQNEDT32 ì·¨ì•½ì  ì‹œë„ íƒì§€"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $eqn = "EQNEDT32.EXE" ascii nocase
        $obj = "{\\object" ascii
        $oledata = "{\\*\\objdata" ascii

    condition:
        all of them
}

rule RTF_Suspicious_Shell_Strings
{
    meta:
        description = "RTF ë‚´ ì™¸ë¶€ ì‹¤í–‰ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì˜ì‹¬ ë¬¸ìì—´ íƒì§€"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $cmd = "cmd.exe" ascii nocase
        $ps = "powershell" ascii nocase
        $url = /http[s]?:\/\/[^\s]+/ ascii
        $dll = ".dll" ascii nocase
        $bat = ".bat" ascii nocase

    condition:
        2 of them
}

// íœ´ë¦¬ìŠ¤í‹± ê¸°ë°˜ íƒì§€ ê·œì¹™ë“¤
rule RTF_Heuristic_Byte_Nibble_Obfuscation
{
    meta:
        description = "RTF ë°”ì´íŠ¸ nibble ë‚œë…í™” ê¸°ë²• íƒì§€"
        author = "Kim"
        severity = "medium"
        category = "heuristic"
        filetype = "rtf"
        reference = "InQuest/yara-rules, Boris Larin research"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // Byte nibble ë‚œë…í™” íŒ¨í„´ë“¤ - ë°”ì´íŠ¸ë¥¼ nibbleë¡œ ë¶„í• 
        $nibble_pattern1 = /\\[0-9a-fA-F]\\[0-9a-fA-F][0-9a-fA-F]/ ascii
        $nibble_pattern2 = /\\[0-9a-fA-F][0-9a-fA-F]\\[0-9a-fA-F]/ ascii
        $nibble_pattern3 = /\\[0-9a-fA-F]\\[0-9a-fA-F]\\[0-9a-fA-F]/ ascii
        
        // 16ì§„ìˆ˜ ì¸ì½”ë”©ê³¼ ë¶„í•  íŒ¨í„´
        $hex_split1 = /[0-9a-fA-F]{2}\\[0-9a-fA-F]{2}/ ascii
        $hex_split2 = /[0-9a-fA-F]\\[0-9a-fA-F]{3}/ ascii
        
        // ì—°ì†ëœ ë°±ìŠ¬ë˜ì‹œ íŒ¨í„´
        $backslash_sequence = /\\\\[0-9a-fA-F]+\\\\[0-9a-fA-F]+/ ascii
        
        // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ 16ì§„ìˆ˜ ë¬¸ìì—´ ê¸¸ì´
        $long_hex_string = /[0-9a-fA-F]{100,}/ ascii

    condition:
        $rtf_header at 0 and 
        (2 of ($nibble_pattern*) or 3 of ($hex_split*) or 
         $backslash_sequence or ($long_hex_string and any of ($nibble_pattern*)))
}

rule RTF_Heuristic_OLE_Exploitation_Patterns
{
    meta:
        description = "RTF OLE ìµìŠ¤í”Œë¡œì‡ íŒ¨í„´ ì¡°í•© íƒì§€"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "Neo23x0/signature-base, CVE analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // OLE êµ¬ì¡° íŒ¨í„´ë“¤
        $ole_object = "{\\object" ascii nocase
        $objdata = "{\\*\\objdata" ascii nocase
        
        // ìµìŠ¤í”Œë¡œì‡ ê´€ë ¨ ê°ì²´ í´ë˜ìŠ¤ë“¤
        $equation_class = "Equation.3" ascii nocase
        $wordpad_class = "WordPad.Document.1" ascii nocase
        $package_class = "Package" ascii nocase
        $ole2link = "OLE2Link" ascii nocase
        
        // ì…¸ì½”ë“œ ì‹¤í–‰ íŒ¨í„´ë“¤
        $shellcode_marker = /0[1-9a-fA-F][0-9a-fA-F]{6,}/ ascii
        $exploit_padding = /90{20,}/ ascii  // NOP sled
        
        // CVE ê´€ë ¨ íŠ¹ì • íŒ¨í„´ë“¤
        $cve_2017_11882 = "EQNEDT32" ascii nocase
        $cve_2018_0802 = "4f1e5b9d-d05c-4564-ba2e-2b0420311520" ascii nocase

    condition:
        $rtf_header at 0 and $ole_object and $objdata and
        (any of ($equation_class, $wordpad_class, $package_class, $ole2link) and
         (any of ($shellcode_marker, $exploit_padding) or 
          any of ($cve_2017_11882, $cve_2018_0802)))
}

rule RTF_Heuristic_Template_Injection
{
    meta:
        description = "RTF í…œí”Œë¦¿ ì¸ì ì…˜ ê³µê²© íŒ¨í„´ íƒì§€"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "sivolko/comprehensive-yara-rules"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // í…œí”Œë¦¿ ê´€ë ¨ RTF ì œì–´ì–´ë“¤
        $template = "\\template" ascii nocase
        $doctemp = "\\doctemp" ascii nocase
        $stylesheet = "\\stylesheet" ascii nocase
        
        // ì™¸ë¶€ ë§í¬ íŒ¨í„´ë“¤
        $http_link = /\\field.*http[s]?:\/\/[^}]+/ ascii nocase
        $file_link = /\\field.*file:\/\/[^}]+/ ascii nocase
        $unc_path = /\\field.*\\\\[^}\\]+\\[^}]+/ ascii nocase
        
        // í•˜ì´í¼ë§í¬ í•„ë“œë“¤
        $hyperlink = "\\fldinst.*HYPERLINK" ascii nocase
        $includetext = "\\fldinst.*INCLUDETEXT" ascii nocase
        $includepicture = "\\fldinst.*INCLUDEPICTURE" ascii nocase
        
        // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™•ì¥ìë“¤
        $dotm_ext = ".dotm" ascii nocase
        $docm_ext = ".docm" ascii nocase
        $dot_ext = ".dot" ascii nocase

    condition:
        $rtf_header at 0 and
        (any of ($template, $doctemp, $stylesheet) or
         any of ($hyperlink, $includetext, $includepicture)) and
        (any of ($http_link, $file_link, $unc_path) and
         any of ($dotm_ext, $docm_ext, $dot_ext))
}

rule RTF_Heuristic_Macro_Execution_Vectors
{
    meta:
        description = "RTF ë§¤í¬ë¡œ ì‹¤í–‰ ë²¡í„° íƒì§€"
        author = "Kim"
        severity = "medium"
        category = "heuristic"
        filetype = "rtf"
        reference = "Yara-Rules/rules, embee-research analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // ë§¤í¬ë¡œ ê´€ë ¨ RTF êµ¬ì¡°ë“¤
        $vba_project = "VBAProject" ascii nocase
        $macro_sheet = "Macrosheet" ascii nocase
        $auto_exec = "Auto_" ascii nocase
        
        // RTF í•„ë“œ ì½”ë“œë“¤
        $field_code = "\\fldinst" ascii nocase
        $dde_field = "\\fldinst.*DDE" ascii nocase
        $macro_button = "\\fldinst.*MACROBUTTON" ascii nocase
        
        // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê´€ë ¨
        $wscript = "WScript" ascii nocase
        $vbscript = "VBScript" ascii nocase
        $javascript = "JavaScript" ascii nocase
        $powershell = "PowerShell" ascii nocase
        
        // ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°ë“¤
        $on_open = "OnOpen" ascii nocase
        $auto_open = "AutoOpen" ascii nocase
        $document_open = "Document_Open" ascii nocase

    condition:
        $rtf_header at 0 and
        ($field_code and ($dde_field or $macro_button)) and
        (any of ($vba_project, $macro_sheet, $auto_exec) or
         any of ($wscript, $vbscript, $javascript, $powershell) or
         any of ($on_open, $auto_open, $document_open))
}

rule RTF_Heuristic_Suspicious_Encoding_Patterns
{
    meta:
        description = "RTF ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì¸ì½”ë”© íŒ¨í„´ íƒì§€"
        author = "Kim"
        severity = "low"
        category = "heuristic"
        filetype = "rtf"
        reference = "Didier Stevens research, InQuest Labs"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // ë¹„ì •ìƒì ì¸ 16ì§„ìˆ˜ ì¸ì½”ë”©
        $hex_overload = /[0-9a-fA-F]{500,}/ ascii
        $mixed_case_hex = /[a-f]{10,}[A-F]{10,}/ ascii
        
        // ì¸ì½”ë”© ì œì–´ë¬¸ë“¤
        $ansi_cpg = "\\ansicpg" ascii
        $uc_value = "\\uc" ascii
        $u_value = "\\u-" ascii  // ìŒìˆ˜ ìœ ë‹ˆì½”ë“œ
        
        // íŠ¹ìˆ˜ ë¬¸ì ì¸ì½”ë”©
        $null_chars = "\\u0" ascii
        $control_chars = /\\u[0-2][0-9]/ ascii
        $high_ascii = /\\u[2-9][0-9]{3}/ ascii
        
        // ì¤‘ë³µë˜ê±°ë‚˜ ë¹„ì •ìƒì ì¸ ì œì–´ ì‹œí€€ìŠ¤ë“¤
        $repeated_controls = /\\[a-z]+[0-9]*\\[a-z]+[0-9]*\\[a-z]+[0-9]*/ ascii
        $malformed_controls = /\\[^a-zA-Z]{2,}/ ascii
        
        // Base64ì™€ ìœ ì‚¬í•œ íŒ¨í„´ë“¤
        $b64_like = /[A-Za-z0-9+\/]{50,}={0,2}/ ascii

    condition:
        $rtf_header at 0 and
        (($hex_overload or $mixed_case_hex) and
         (any of ($ansi_cpg, $uc_value, $u_value) or
          2 of ($null_chars, $control_chars, $high_ascii)) or
         ($repeated_controls and $malformed_controls) or
         ($b64_like and any of ($null_chars, $control_chars)))
}

rule RTF_Heuristic_Embedded_PE_Patterns
{
    meta:
        description = "RTF ë‚´ ì„ë² ë””ë“œ PE íŒŒì¼ íŒ¨í„´ íƒì§€"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "InQuest/yara-rules embedded PE analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // PE í—¤ë”ë“¤ (16ì§„ìˆ˜ ì¸ì½”ë”©ëœ)
        $pe_mz = "4d5a" ascii nocase  // MZ
        $pe_header = "50450000" ascii nocase  // PE\0\0
        $dos_stub = "546869732070726f6772616d" ascii nocase  // "This program"
        
        // PE ì„¹ì…˜ë“¤
        $text_section = "2e74657874" ascii nocase  // .text
        $data_section = "2e64617461" ascii nocase  // .data
        $rdata_section = "2e7264617461" ascii nocase  // .rdata
        
        // DLL/EXE ê´€ë ¨ ë¬¸ìì—´ë“¤ (16ì§„ìˆ˜ ì¸ì½”ë”©)
        $kernel32 = "4b45524e454c3332" ascii nocase  // KERNEL32
        $user32 = "5553455233320000" ascii nocase    // USER32
        $ntdll = "6e74646c6c2e646c6c" ascii nocase   // ntdll.dll
        
        // ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼ í™•ì¥ìë“¤
        $exe_extension = "2e657865" ascii nocase  // .exe
        $dll_extension = "2e646c6c" ascii nocase  // .dll
        $scr_extension = "2e736372" ascii nocase  // .scr
        
        // OLE íŒ¨í‚¤ì§€ ë‚´ PE êµ¬ì¡°
        $ole_package = "{\\object" ascii nocase
        $package_data = "\\objdata" ascii nocase

    condition:
        $rtf_header at 0 and
        ($pe_mz and ($pe_header or $dos_stub)) and
        (any of ($text_section, $data_section, $rdata_section) or
         any of ($kernel32, $user32, $ntdll)) and
        (any of ($exe_extension, $dll_extension, $scr_extension) or
         ($ole_package and $package_data))
}

rule RTF_Heuristic_Exploitation_Techniques_Combination
{
    meta:
        description = "RTF ìµìŠ¤í”Œë¡œì‡ ê¸°ë²• ì¡°í•© íƒì§€"
        author = "Kim"
        severity = "high"
        category = "heuristic"
        filetype = "rtf"
        reference = "Multiple CVE analysis and threat research"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // í™ ìŠ¤í”„ë ˆì´ íŒ¨í„´ë“¤
        $heap_spray1 = /90{50,}/ ascii  // ê¸´ NOP sled
        $heap_spray2 = /41{50,}/ ascii  // AAAA pattern
        $heap_spray3 = /0c0c0c0c/ ascii nocase  // ë°˜ë³µ íŒ¨í„´
        
        // ROP ì²´ì¸ íŒ¨í„´ë“¤
        $rop_gadget = /5[0-9a-fA-F]{7}/ ascii  // potential addresses
        $stack_pivot = /8b[0-9a-fA-F]{6}/ ascii  // mov instruction patterns
        
        // ë©”ëª¨ë¦¬ ì†ìƒ íŒ¨í„´ë“¤
        $buffer_overflow = /90{100,}/ ascii
        $format_string = /%[0-9]*[sdxp]/ ascii
        $integer_overflow = /ffff/ ascii nocase
        
        // ì½”ë“œ ì‹¤í–‰ ë²¡í„°ë“¤
        $code_exec1 = "\\fldinst.*DDE.*cmd" ascii nocase
        $code_exec2 = "{\\object.*\\objdata.*4d5a" ascii nocase  // OLE with PE
        $code_exec3 = "EQNEDT32" ascii nocase
        
        // ìš°íšŒ ê¸°ë²•ë“¤
        $obfuscation = /\\[0-9a-fA-F]\\[0-9a-fA-F]/ ascii  // nibble obfuscation
        $padding = /00{20,}/ ascii  // null padding
        
        // CVE ì‹ë³„ìë“¤
        $cve_patterns = /(CVE-201[7-9]-[0-9]{4,5}|CVE-202[0-9]-[0-9]{4,5})/ ascii nocase

    condition:
        $rtf_header at 0 and
        (any of ($heap_spray*) or any of ($rop_gadget, $stack_pivot)) and
        (any of ($buffer_overflow, $format_string, $integer_overflow) or
         any of ($code_exec*)) and
        ($obfuscation or $padding or $cve_patterns)
}

rule RTF_Heuristic_High_Risk_Combination
{
    meta:
        description = "RTF ê³ ìœ„í—˜ íŒ¨í„´ ì¡°í•© íƒì§€"
        author = "Kim"
        severity = "critical"
        category = "heuristic"
        filetype = "rtf"
        reference = "Comprehensive threat analysis"

    strings:
        $rtf_header = "{\\rtf1" ascii nocase
        
        // OLE ê°ì²´ ì¡´ì¬
        $ole_object = "{\\object" ascii nocase
        $objdata = "\\objdata" ascii nocase
        
        // ìµìŠ¤í”Œë¡œì‡ í´ë˜ìŠ¤
        $exploit_class = /(Equation\.3|EQNEDT32|Package)/ ascii nocase
        
        // ì…¸ì½”ë“œ íŒ¨í„´
        $shellcode = /(90{20,}|4d5a[0-9a-fA-F]{10,})/ ascii nocase
        
        // ë‚œë…í™”
        $obfuscation = /\\[0-9a-fA-F]\\[0-9a-fA-F][0-9a-fA-F]/ ascii
        
        // ì‹¤í–‰ ë²¡í„°
        $execution = /(cmd\.exe|powershell|wscript|mshta)/ ascii nocase
        
        // ë„¤íŠ¸ì›Œí¬ í™œë™
        $network = /http[s]?:\/\/[a-zA-Z0-9.-]+/ ascii nocase
        
        // ì§€ì†ì„± ë©”ì»¤ë‹ˆì¦˜
        $persistence = /(startup|\\Run\\|schtasks|autostart)/ ascii nocase

    condition:
        $rtf_header at 0 and $ole_object and $objdata and $exploit_class and
        ($shellcode and $obfuscation) and
        ($execution or $network or $persistence)
}

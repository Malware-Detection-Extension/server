// 📄 대상 확장자: .rtf
// 🧩 대상 프로그램: Microsoft Word, WordPad 등
// 🎯 탐지 목적: RTF 문서 내 OLE 개체, 쉘코드, 취약점 공격 패턴 탐지

rule RTF_Embedded_OLE_Object
{
    meta:
        description = "RTF 문서 내 OLE 개체 삽입 탐지 ({\\object, {\\objdata})"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $obj1 = "{\\object" ascii nocase
        $obj2 = "{\\objdata" ascii nocase
        $class = "objclass" ascii nocase
        $exe = ".exe" ascii nocase

    condition:
        $header at 0 and (2 of ($obj*, $class, $exe))
}

rule RTF_Nop_Sled_Heuristic
{
    meta:
        description = "RTF 문서 내 NOP sled 기반 쉘코드 존재 가능성 탐지"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $header = "{\\rtf" ascii
        $nop = { 90 90 90 90 90 90 90 90 90 90 }  // 긴 NOP sled
        $jmp = { E9 ?? ?? ?? ?? }                // jmp instruction
        $call = { E8 ?? ?? ?? ?? }               // call instruction

    condition:
        $header at 0 and (1 of ($nop, $jmp, $call))
}

rule RTF_Exploit_CVE_2017_11882
{
    meta:
        description = "CVE-2017-11882 EQNEDT32 취약점 시도 탐지"
        author = "Seo"
        severity = "high"
        category = "document"

    strings:
        $eqn = "EQNEDT32.EXE" ascii nocase
        $obj = "{\\object" ascii
        $oledata = "{\\*\\objdata" ascii

    condition:
        all of them
}

rule RTF_Suspicious_Shell_Strings
{
    meta:
        description = "RTF 내 외부 실행 가능성이 있는 의심 문자열 탐지"
        author = "Seo"
        severity = "medium"
        category = "document"

    strings:
        $cmd = "cmd.exe" ascii nocase
        $ps = "powershell" ascii nocase
        $url = /http[s]?:\/\/[^\s]+/ ascii
        $dll = ".dll" ascii nocase
        $bat = ".bat" ascii nocase

    condition:
        2 of them
}
